<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Welcome | All-In Chat Poker</title>
  <link rel="icon" type="image/png" href="logo.png">
  <link rel="stylesheet" href="style-theme.css">
  <link rel="stylesheet" href="style-welcome-enhanced.css">
</head>
<body>
  <!-- Animated Background -->
  <div class="bg-animation">
    <div class="floating-cards"></div>
    <div class="poker-chips"></div>
    <div class="audio-waves"></div>
  </div>

  <div class="wrap">
    <!-- Hero Section -->
    <div class="hero">
      <div class="hero-nav-bar">
        <div class="brand-chip">
          <img src="logo.png" alt="All-In Chat Poker" class="brand-logo">
          <span>All-In Chat Poker</span>
        </div>
        <nav class="hero-nav" aria-label="Primary">
          <a class="nav-link" href="/overlay-editor-enhanced.html" target="_blank" rel="noopener">
            <span class="nav-icon">ğŸ¨</span> Editor
          </a>
          <a class="nav-link" href="/admin-enhanced.html" target="_blank" rel="noopener">
            <span class="nav-icon">âš™ï¸</span> Admin
          </a>
          <a class="nav-link" href="/setup.html" target="_blank" rel="noopener">
            <span class="nav-icon">ğŸ”§</span> Setup
          </a>
          <a class="nav-link" href="/store-enhanced.html" target="_blank" rel="noopener">
            <span class="nav-icon">ğŸ›ï¸</span> Store
          </a>
          <a class="nav-link" href="/partner-program.html" target="_blank" rel="noopener">
            <span class="nav-icon">ğŸ¯</span> Partners
          </a>
          <a class="nav-link" href="/profile-enhanced.html" target="_blank" rel="noopener">
            <span class="nav-icon">ğŸ‘¤</span> Profile
          </a>
          <a class="nav-link ghost" href="https://www.paypal.com/donate/?hosted_button_id=STB7K4BTREWDC" target="_blank" rel="noopener">
            <span class="nav-icon">â¤ï¸</span> Support
          </a>
        </nav>
      </div>
      
      <div class="hero-content">
        <div class="hero-logo-container">
          <img src="logo.png" alt="All-In Chat Poker" class="hero-logo">
          <div class="logo-glow"></div>
        </div>
        
        <h1>Bring Twitch Chat to the Table</h1>
        <p class="lede">
          Spin up live Blackjack and Video Poker rounds where viewers join with <code>!join</code> or place bets right from chat. 
          Drop the overlay into OBS, start rounds from the admin panel, and let the hype take over.
        </p>
        
        <div class="feature-badges">
          <span class="badge badge-primary">ğŸµ DMCA-Safe Audio</span>
          <span class="badge badge-secondary">ğŸ® Live Gaming</span>
          <span class="badge badge-tertiary">ğŸ¥ Streamer Tools</span>
          <span class="badge badge-quaternary">ğŸ¤– AI Powered</span>
        </div>
        
        <div class="status-pill">
          <span class="status-dot"></span>
          Status: Alpha testing (multi-stream lobbies + avatars)
        </div>
      </div>
    </div>

    <!-- Features Grid -->
    <div class="grid">
      <div class="card feature-card">
        <div class="card-icon">ğŸ¯</div>
        <h2>Why it's fun</h2>
        <ul>
          <li>Chat becomes the table: viewers jump in with one command.</li>
          <li>Bold OBS overlay with avatars, seating, and live pot glow.</li>
          <li>Blackjack and poker flows you control from one panel.</li>
          <li>Poker is for multi-stream lobbies only; see the <a href="/poker-rules.html">poker rules</a>.</li>
          <li>Texas Hold'em details: <a href="/holdem-rules.html">Hold'em rules</a>.</li>
        </ul>
      </div>

      <div class="card feature-card">
        <div class="card-icon">ğŸš€</div>
        <h2>Quick start</h2>
        <ul>
          <li>OBS: copy your channel-scoped Browser Source from your Profile page.</li>
          <li>Auto-join: when the streamer logs in, their channel is added for the bot.</li>
          <li>Blackjack rules: see <a href="/blackjack-rules.html">/blackjack-rules.html</a>.</li>
        </ul>
      </div>

      <div class="card feature-card">
        <div class="card-icon">ğŸ’</div>
        <h2>Support the table</h2>
        <p class="muted">If you're vibing with All-In Chat Poker (powered by allinchatpokerbot), toss a tip to keep the felt glowing.</p>
        <a class="btn btn-primary" href="https://www.paypal.com/donate/?hosted_button_id=STB7K4BTREWDC" target="_blank" rel="noopener">
          <span class="btn-icon">ğŸ’</span> Send a PayPal tip
        </a>
      </div>
    </div>

    <!-- Visual Assets Gallery -->
    <div class="card gallery-card">
      <h2>Vibes from the felt</h2>
      <p class="muted">Live assets the overlay already ships with: card backs, chip stacks, deal and win FX, plus the neon table frame.</p>
      
      <div class="gallery">
        <!-- Card Back -->
        <div class="gallery-item">
          <img src="/assets/cosmetics/cards/streamer/card-back-streamer.png" alt="Epic streamer card back" class="gallery-img">
          <div class="gallery-label">Epic Card Back</div>
        </div>
        
        <!-- Chip Stack -->
        <div class="gallery-item">
          <div class="stacked-chips">
            <div class="chip-main-stack">
              <img src="/assets/cosmetics/effects/chips/chip-500-top.png" alt="500 chip" class="chip-stack-item">
              <img src="/assets/cosmetics/effects/chips/chip-100-top.png" alt="100 chip" class="chip-stack-item">
              <img src="/assets/cosmetics/effects/chips/chip-25-top.png" alt="25 chip" class="chip-stack-item">
              <img src="/assets/cosmetics/effects/chips/chip-5-top.png" alt="5 chip" class="chip-stack-item">
              <img src="/assets/cosmetics/effects/chips/chip-1-top.png" alt="1 chip" class="chip-stack-item">
            </div>
            <div class="chip-side-chips">
              <img src="/assets/cosmetics/effects/chips/chip-100-top.png" alt="100 chip side" class="chip-stack-item">
              <img src="/assets/cosmetics/effects/chips/chip-25-top.png" alt="25 chip side" class="chip-stack-item">
            </div>
          </div>
          <div class="gallery-label">Multi-Denomination Chip Stack</div>
        </div>
        
        <!-- Deal Animation -->
        <div class="gallery-item">
          <img src="/assets/cosmetics/effects/deals/face-down-deal.png" alt="Face-down deal animation sheet" class="gallery-img">
          <div class="gallery-label">Deal Animation</div>
        </div>
        
        <!-- Win Burst Canvas -->
        <div class="gallery-item">
          <canvas class="sprite-preview-canvas" id="winburst-canvas" aria-label="Win burst sprite preview"></canvas>
          <div class="gallery-label">Win Effect</div>
        </div>
        
        <!-- All-in Sprite -->
        <div class="gallery-item">
          <div class="sprite-preview" id="allin-sprite-preview" aria-label="All-in burst sprite preview">
            <div class="fallback-animation">All-in Effect</div>
          </div>
          <div class="gallery-label">All-in Effect</div>
        </div>
        
        <!-- Table Preview -->
        <div class="gallery-item">
          <div class="gallery-table-preview" aria-label="Neon table preview">
            <div class="table-center">All streamers vs allinchatpokerbot</div>
            <div class="table-cards">
              <span class="card-mini">Aâ™ </span>
              <span class="card-mini">Kâ™£</span>
            </div>
          </div>
          <div class="gallery-label">Neon Table</div>
        </div>
      </div>
    </div>

    <!-- Suggestion Box -->
    <div class="card suggestion-card">
      <div class="card-icon">ğŸ’¬</div>
      <h2>Suggestion box</h2>
      <p class="muted">Have an idea or spotted a bug? Send it straight to the team.</p>
      <div class="suggestion-form">
        <input id="suggestion-name" type="text" placeholder="Your name (optional)" class="form-control">
        <textarea id="suggestion-text" rows="3" placeholder="Share feedback, feature ideas, or issues..." class="form-control"></textarea>
        <button id="send-suggestion" class="btn btn-primary">
          <span class="btn-icon">ğŸ“§</span> Email feedback
        </button>
      </div>
    </div>

    <!-- Footer -->
    <div class="welcome-footer">
      <div class="footer-content">
        <p>ğŸ° Professional Video Poker Platform for Streamers</p>
        <div class="footer-links">
          <a href="/privacy" class="footer-link">Privacy</a>
          <span class="separator">â€¢</span>
          <a href="/terms" class="footer-link">Terms</a>
          <span class="separator">â€¢</span>
          <a href="/support" class="footer-link">Support</a>
          <span class="separator">â€¢</span>
          <a href="/discord" class="footer-link">Discord</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      // Suggestion form handler
      const btn = document.getElementById('send-suggestion');
      if (!btn) return;
      btn.addEventListener('click', () => {
        const name = document.getElementById('suggestion-name')?.value.trim();
        const message = document.getElementById('suggestion-text')?.value.trim();
        if (!message) {
          showNotification('Please add a quick message before sending.', 'warning');
          return;
        }
        const subject = encodeURIComponent('All-In Chat Poker suggestion');
        const bodyLines = [
          name ? 'From: ' + name : '',
          '',
          message
        ].filter(Boolean);
        const body = encodeURIComponent(bodyLines.join('\n'));
        window.location.href = 'mailto:allinchatpoker@gmail.com?subject=' + subject + '&body=' + body;
      });
    })();

    // Enhanced sprite preview with fallback
    (function () {
      const preview = document.getElementById('allin-sprite-preview');
      if (!preview) return;
      const SPRITE_URL = '/assets/cosmetics/effects/all-in/allin_burst_horizontal_sheet.png?v=3';
      const img = new Image();
      img.onload = () => {
        if (!img.naturalHeight) return;
        const frames = Math.max(1, Math.round(img.naturalWidth / img.naturalHeight));
        preview.style.setProperty('--frames', frames);
        preview.style.backgroundImage = `url('${SPRITE_URL}')`;
        preview.setAttribute('aria-label', `All-in burst sprite preview (${frames} frames)`);
        preview.classList.add('loaded');
      };
      img.onerror = () => {
        // Fallback to CSS animation
        preview.classList.add('fallback-mode');
        preview.setAttribute('aria-label', 'All-in burst CSS animation fallback');
      };
      img.src = SPRITE_URL;
      
      // Fallback while loading
      preview.style.backgroundImage = `url('${SPRITE_URL}')`;
      preview.style.setProperty('--frames', 6);
    })();

    // Enhanced win burst animation with fallback
    (function () {
      const canvas = document.getElementById('winburst-canvas');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const SPRITE_URL = '/assets/cosmetics/effects/win/AllInChatPoker_Glitch_24Frames_1024x1024_Horizontal_FIXED.png';
      const meta = { columns: 24, rows: 1, frameCount: 24, fps: 18, frameWidth: 1024, frameHeight: 1024 };
      canvas.width = 256;
      canvas.height = 180;
      
      const img = new Image();
      img.onload = () => {
        const cols = Math.max(1, meta.columns || Math.floor(img.naturalWidth / (meta.frameWidth || img.naturalWidth)));
        const rows = Math.max(1, meta.rows || Math.ceil((meta.frameCount || cols) / cols));
        const frames = meta.frameCount || cols * rows;
        const fw = meta.frameWidth || Math.floor(img.naturalWidth / cols);
        const fh = meta.frameHeight || Math.floor(img.naturalHeight / rows);
        let frame = 0;
        
        console.debug('[winburst] loaded', { w: img.naturalWidth, h: img.naturalHeight, fw, fh, cols, rows, frames });
        
        const draw = () => {
          if (!canvas.isConnected) return;
          const f = frame % frames;
          const col = f % cols;
          const row = Math.floor(f / cols);
          const sx = col * fw;
          const sy = row * fh;
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, sx, sy, fw, fh, 0, 0, canvas.width, canvas.height);
          frame += 1;
          setTimeout(() => requestAnimationFrame(draw), Math.max(20, 1000 / (meta.fps || 24)));
        };
        draw();
      };
      
      img.onerror = (e) => {
        console.warn('[winburst] failed to load sprite, using fallback', e);
        // Fallback CSS animation
        canvas.style.display = 'none';
        const fallback = document.createElement('div');
        fallback.className = 'win-burst-fallback';
        fallback.innerHTML = '<div class="burst-effect">ğŸ’¥</div>';
        canvas.parentNode.appendChild(fallback);
      };
      
      img.src = SPRITE_URL;
    })();

    // Enhanced overlay link handling
    document.addEventListener('DOMContentLoaded', () => {
      const decodeLogin = (tok) => {
        try {
          const payload = tok.split('.')[1];
          const pad = payload.length % 4 === 2 ? '==' : payload.length % 4 === 3 ? '=' : '';
          const data = JSON.parse(atob(payload.replace(/-/g, '+').replace(/_/g, '/') + pad));
          return (data.user || data.login || '').toLowerCase();
        } catch {
          return '';
        }
      };
      
      // Initialize authentication state
      (async () => {
        // Validate token server-side before proceeding
        const validateToken = async (token) => {
          try {
            const response = await fetch('/api/auth/validate', {
              method: 'GET',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
              }
            });
            
            if (response.ok) {
              const data = await response.json();
              return data.valid ? data.login : null;
            }
            return null;
          } catch (err) {
            console.error('Token validation failed:', err);
            return null;
          }
        };
        
        const tok = (localStorage.getItem && localStorage.getItem('user_jwt')) || '';
        const login = await validateToken(tok);
      
      // Handle return URL from redirect
      const urlParams = new URLSearchParams(window.location.search);
      const returnUrl = urlParams.get('return');
      
      // Update navigation based on auth status
      const navLinks = document.querySelectorAll('.nav-link');
      const overlayLink = document.querySelector('a[href*="obs-overlay"]');
      
      if (login) {
        // User is logged in - show authenticated state
        if (overlayLink) {
          overlayLink.href = `/obs-overlay.html?channel=${encodeURIComponent(login)}`;
        }
        
        // Update navigation links to include auth
        navLinks.forEach(link => {
          const href = link.getAttribute('href');
          if (href && !href.includes('obs-overlay') && !href.includes('paypal.com')) {
            link.setAttribute('href', href);
            link.removeAttribute('target');
            link.removeAttribute('rel');
          }
        });
        
        // Show logged-in notification if returning from redirect (but avoid infinite loops)
        if (returnUrl && !window.location.pathname.includes('welcome-enhanced.html')) {
          showNotification(`Welcome back, ${login}! Redirecting...`, 'success');
          setTimeout(() => {
            window.location.href = decodeURIComponent(returnUrl);
          }, 1500);
        }
      } else {
        // User is not logged in - show login prompt for protected pages
        navLinks.forEach(link => {
          const href = link.getAttribute('href');
          if (href && (href.includes('store') || href.includes('admin') || href.includes('overlay-editor') || href.includes('profile'))) {
            link.addEventListener('click', (e) => {
              e.preventDefault();
              showNotification('Please log in to access this feature', 'warning');
              // Redirect to login page with return URL
              const returnUrl = encodeURIComponent(href);
              window.location.href = `/login.html?return=${returnUrl}`;
            });
          }
        });
        
        if (returnUrl && !window.location.pathname.includes('welcome-enhanced.html')) {
          showNotification('Please log in to continue', 'warning');
          setTimeout(() => {
            window.location.href = `/login.html?return=${returnUrl}`;
          }, 1500);
        }
      }
      
      // Clear invalid token
      if (tok && !login) {
        localStorage.removeItem('user_jwt');
      }
      
      // Notification system
      function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.classList.add('show');
        }, 100);
        
        setTimeout(() => {
          notification.classList.remove('show');
          setTimeout(() => {
            document.body.removeChild(notification);
          }, 300);
        }, 3000);
      }
      
      // Initialize animations
      initializeAnimations();
      
      function initializeAnimations() {
        // Animate hero content on load
        const heroContent = document.querySelector('.hero-content');
        if (heroContent) {
          heroContent.style.opacity = '0';
          heroContent.style.transform = 'translateY(30px)';
          
          setTimeout(() => {
            heroContent.style.transition = 'all 1s ease';
            heroContent.style.opacity = '1';
            heroContent.style.transform = 'translateY(0)';
          }, 100);
        }
        
        // Animate cards on scroll
        const cards = document.querySelectorAll('.card');
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              entry.target.style.opacity = '0';
              entry.target.style.transform = 'translateY(20px)';
              
              setTimeout(() => {
                entry.target.style.transition = 'all 0.6s ease';
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
              }, 100);
              
              observer.unobserve(entry.target);
            }
          });
        });
        
        cards.forEach(card => observer.observe(card));
      })();
    });
    </script>
</body>
</html>
