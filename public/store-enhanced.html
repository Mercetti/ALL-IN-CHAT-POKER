<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Poker Store - Enhanced</title>
  <link rel="stylesheet" href="style-theme.css">
  <link rel="stylesheet" href="style-store-enhanced.css?v=7">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="enhanced-background">
    <div class="floating-cards">
      <div class="floating-card card-1">‚ô†</div>
      <div class="floating-card card-2">‚ô•</div>
      <div class="floating-card card-3">‚ô¶</div>
      <div class="floating-card card-4">‚ô£</div>
      <div class="floating-card card-5">üëë</div>
    </div>
    <div class="gradient-orbs">
      <div class="orb orb-1"></div>
      <div class="orb orb-2"></div>
      <div class="orb orb-3"></div>
    </div>
  </div>

  <div class="main-container">
    <header class="enhanced-header">
      <div class="header-content">
        <div class="logo-section">
          <div class="logo">
            <div class="logo-icon">üé∞</div>
            <div class="logo-text">
              <h1>ALL-IN CHAT</h1>
              <span class="logo-subtitle">Store</span>
            </div>
          </div>
        </div>
        <nav class="header-nav">
          <button class="nav-btn" data-page="editor">
            <span class="nav-icon">üé®</span>
            <span>Editor</span>
          </button>
          <button class="nav-btn active" data-page="store">
            <span class="nav-icon">üõí</span>
            <span>Store</span>
          </button>
          <button class="nav-btn" data-page="profile">
            <span class="nav-icon">üë§</span>
            <span>Profile</span>
          </button>
        </nav>
        <div class="header-actions">
          <div class="user-balance">
            <span class="balance-icon">üí∞</span>
            <span class="balance-amount" id="user-balance">0</span>
          </div>
          <button class="help-btn" title="Help & Documentation">
            <span>‚ùì</span>
          </button>
        </div>
      </div>
    </header>

    <main class="enhanced-main">
      <!-- Hero Section -->
      <section class="hero-section glass-panel">
        <div class="hero-content">
          <div class="hero-text">
            <h2>Premium Cosmetics Store</h2>
            <p>Customize your poker experience with exclusive card backs, table skins, avatar accessories, and more!</p>
            <div class="hero-stats">
              <div class="stat-item">
                <span class="stat-number">500+</span>
                <span class="stat-label">Items</span>
              </div>
              <div class="stat-item">
                <span class="stat-number">50+</span>
                <span class="stat-label">Themes</span>
              </div>
              <div class="stat-item">
                <span class="stat-number">24/7</span>
                <span class="stat-label">Support</span>
              </div>
            </div>
          </div>
          <div class="hero-visual">
            <div class="showcase-items">
              <div class="showcase-item card-back">
                <div class="item-preview">
                  <img src="/assets/cosmetics/cards/basic/card-back-purple.svg" alt="Card Back">
                </div>
                <span>Card Backs</span>
              </div>
              <div class="showcase-item table-skin">
                <div class="item-preview">
                  <img src="/assets/cosmetics/table/neon_green.svg" alt="Table Skin">
                </div>
                <span>Table Skins</span>
              </div>
              <div class="showcase-item avatar-ring">
                <div class="item-preview">
                  <img src="/assets/cosmetics/avatar/fire_ring.svg" alt="Avatar Ring">
                </div>
                <span>Avatar Rings</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Store Navigation -->
      <section class="store-nav glass-panel">
        <div class="nav-tabs">
          <button class="tab-btn active" data-category="all">All Items</button>
          <button class="tab-btn" data-category="featured">Featured</button>
          <button class="tab-btn" data-category="new">New Arrivals</button>
          <button class="tab-btn" data-category="sale">On Sale</button>
          <button class="tab-btn" data-category="premium">Premium</button>
        </div>
        <div class="nav-filters">
          <div class="filter-group">
            <label class="filter-label">Category</label>
            <select id="category-filter" class="filter-select">
              <option value="">All Categories</option>
              <option value="cardBack">Card Backs</option>
              <option value="cardFace">Card Faces</option>
              <option value="tableSkin">Table Skins</option>
              <option value="avatarRing">Avatar Rings</option>
              <option value="chipSkin">Chip Skins</option>
              <option value="nameplate">Nameplates</option>
              <option value="dealFx">Deal Effects</option>
              <option value="winFx">Win Effects</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Rarity</label>
            <select id="rarity-filter" class="filter-select">
              <option value="">All Rarities</option>
              <option value="common">Common</option>
              <option value="rare">Rare</option>
              <option value="epic">Epic</option>
              <option value="legendary">Legendary</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">Price Range</label>
            <select id="price-filter" class="filter-select">
              <option value="">Any Price</option>
              <option value="free">Free</option>
              <option value="0-5">$0 - $5</option>
              <option value="5-15">$5 - $15</option>
              <option value="15-30">$15 - $30</option>
              <option value="30+">$30+</option>
            </select>
          </div>
          <div class="search-group">
            <input type="text" id="search-input" placeholder="Search items..." class="search-input">
            <button class="search-btn">
              <span>üîç</span>
            </button>
          </div>
        </div>
      </section>

      <!-- Featured Collections -->
      <section class="featured-collections glass-panel">
        <h3>Featured Collections</h3>
        <div class="collections-grid">
          <div class="collection-card neon-collection">
            <div class="collection-header">
              <h4>Neon Nights</h4>
              <span class="collection-badge">Limited</span>
            </div>
            <div class="collection-preview">
              <img src="/assets/cosmetics/cards/basic/card-back-purple.svg" alt="Neon Collection">
            </div>
            <div class="collection-info">
              <p>Glowing neon aesthetics for the modern player</p>
              <button class="btn btn-outline btn-sm">View Collection</button>
            </div>
          </div>
          <div class="collection-card vintage-collection">
            <div class="collection-header">
              <h4>Vintage Vegas</h4>
              <span class="collection-badge">Classic</span>
            </div>
            <div class="collection-preview">
              <img src="/assets/cosmetics/table/neon_green.svg" alt="Vintage Collection">
            </div>
            <div class="collection-info">
              <p>Classic casino style from the golden era</p>
              <button class="btn btn-outline btn-sm">View Collection</button>
            </div>
          </div>
          <div class="collection-card cosmic-collection">
            <div class="collection-header">
              <h4>Cosmic Dreams</h4>
              <span class="collection-badge">Premium</span>
            </div>
            <div class="collection-preview">
              <img src="/assets/cosmetics/avatar/fire_ring.svg" alt="Cosmic Collection">
            </div>
            <div class="collection-info">
              <p>Otherworldly designs for cosmic players</p>
              <button class="btn btn-outline btn-sm">View Collection</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Store Items Grid -->
      <section class="store-content">
        <div class="content-header">
          <h3 id="section-title">All Items</h3>
          <div class="view-options">
            <button class="view-btn active" data-view="grid">
              <span>‚äû</span>
            </button>
            <button class="view-btn" data-view="list">
              <span>‚ò∞</span>
            </button>
          </div>
        </div>
        
        <div class="catalog-status" id="catalog-status">Loading catalog...</div>
        
        <div class="items-grid-container glass-panel">
          <div class="items-grid" id="items-grid">
            <!-- Items will be populated here -->
          </div>
        </div>
        
        <div class="pagination-controls" id="pagination">
          <!-- Pagination will be populated here -->
        </div>
      </section>

      <!-- Special Offers -->
      <section class="special-offers glass-panel">
        <h3>Special Offers & Bundles</h3>
        <div class="offers-grid">
          <div class="offer-card starter-bundle">
            <div class="offer-header">
              <h4>Starter Bundle</h4>
              <span class="offer-badge">Best Value</span>
            </div>
            <div class="offer-content">
              <div class="offer-items">
                <span>5 Card Backs</span>
                <span>3 Table Skins</span>
                <span>2 Avatar Rings</span>
              </div>
              <div class="offer-price">
                <span class="original-price">$25.00</span>
                <span class="current-price">$15.99</span>
              </div>
              <button class="btn btn-primary">Buy Now</button>
            </div>
          </div>
          <div class="offer-card premium-pass">
            <div class="offer-header">
              <h4>Premium Pass</h4>
              <span class="offer-badge">Popular</span>
            </div>
            <div class="offer-content">
              <div class="offer-items">
                <span>All Current Items</span>
                <span>Future Releases</span>
                <span>Exclusive Access</span>
              </div>
              <div class="offer-price">
                <span class="current-price">$49.99</span>
                <span class="price-period">/month</span>
              </div>
              <button class="btn btn-primary">Subscribe</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Mystery Box Section -->
      <section class="mystery-box glass-panel">
        <div class="mystery-header">
          <h3>üéÅ Mystery Boxes</h3>
          <p>Random cosmetic rewards with guaranteed value!</p>
        </div>
        <div class="mystery-grid" id="mystery-grid">
          <!-- Mystery boxes will be populated here -->
        </div>
      </section>

      <!-- AIC Packs Section -->
      <section class="aic-packs glass-panel">
        <div class="aic-header">
          <h3>AI-Generated Cosmetics</h3>
          <p>Unique, one-of-a-kind designs created by artificial intelligence</p>
        </div>
        <div class="aic-grid" id="aic-grid">
          <!-- AIC packs will be populated here -->
        </div>
      </section>
    </main>

    <!-- Item Detail Modal -->
    <div class="modal-overlay" id="item-modal">
      <div class="modal-content glass-panel">
        <div class="modal-header">
          <h3 id="modal-title">Item Details</h3>
          <button class="modal-close" id="modal-close">√ó</button>
        </div>
        <div class="modal-body">
          <div class="modal-preview" id="modal-preview">
            <!-- Preview will be populated here -->
          </div>
          <div class="modal-info">
            <div class="item-details">
              <h4 id="modal-item-name">Item Name</h4>
              <div class="item-meta">
                <span class="rarity-badge" id="modal-rarity">Common</span>
                <span class="item-category" id="modal-category">Category</span>
              </div>
              <p class="item-description" id="modal-description">Item description goes here.</p>
              <div class="item-stats">
                <div class="stat">
                  <span class="stat-label">Owned:</span>
                  <span class="stat-value" id="modal-owned">No</span>
                </div>
                <div class="stat">
                  <span class="stat-label">Equipped:</span>
                  <span class="stat-value" id="modal-equipped">No</span>
                </div>
              </div>
            </div>
            <div class="purchase-info">
              <div class="price-display">
                <span class="price-label">Price:</span>
                <span class="price-value" id="modal-price">$0.00</span>
              </div>
              <div class="modal-actions">
                <button class="btn btn-primary" id="modal-buy-btn">Purchase</button>
                <button class="btn btn-secondary" id="modal-equip-btn" disabled>Equip</button>
                <button class="btn btn-outline" id="modal-preview-btn">Preview</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Notification Container -->
    <div class="notification-container" id="notification-container"></div>
  </div>

  <script>
    // Enhanced notification system
    class NotificationSystem {
      constructor() {
        this.container = document.getElementById('notification-container');
      }

      show(message, type = 'info', duration = 3000) {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
          <div class="notification-content">
            <span class="notification-icon">${this.getIcon(type)}</span>
            <span class="notification-message">${message}</span>
          </div>
          <button class="notification-close" onclick="this.parentElement.remove()">√ó</button>
        `;
        
        this.container.appendChild(notification);
        
        // Auto remove
        setTimeout(() => {
          if (notification.parentElement) {
            notification.remove();
          }
        }, duration);
      }

      getIcon(type) {
        const icons = {
          success: '‚úÖ',
          error: '‚ùå',
          warning: '‚ö†Ô∏è',
          info: '‚ÑπÔ∏è'
        };
        return icons[type] || icons.info;
      }
    }

    const notifications = new NotificationSystem();

    // Store functionality
    class StoreManager {
      constructor() {
        this.catalog = [];
        this.filteredCatalog = [];
        this.currentPage = 1;
        this.itemsPerPage = 12;
        this.userBalance = 5000;
        this.ownedItems = new Set(['card-back-basic', 'avatar-ring-default']);
        this.equippedItems = {
          cardBack: 'card-back-basic',
          avatarRing: 'avatar-ring-default'
        };
        this.currentFilter = 'all';
        this.currentSort = 'name';
        this.mysteryBoxes = [
          {
            id: 'box-basic',
            name: 'Basic Mystery Box',
            price: 499,
            preview: '/assets/mystery-box-basic.png',
            description: 'Contains 1-3 random common cosmetics',
            guaranteedValue: 500,
            possibleRewards: [
              { type: 'cardBack', rarity: 'common', chance: 40 },
              { type: 'avatarRing', rarity: 'common', chance: 30 },
              { type: 'tableSkin', rarity: 'common', chance: 30 }
            ]
          },
          {
            id: 'box-premium',
            name: 'Premium Mystery Box',
            price: 1499,
            preview: '/assets/mystery-box-premium.png',
            description: 'Contains 2-4 random cosmetics with rare chances',
            guaranteedValue: 1500,
            possibleRewards: [
              { type: 'cardBack', rarity: 'rare', chance: 25 },
              { type: 'avatarRing', rarity: 'rare', chance: 20 },
              { type: 'tableSkin', rarity: 'epic', chance: 15 },
              { type: 'chip-set', rarity: 'rare', chance: 40 }
            ]
          },
          {
            id: 'box-legendary',
            name: 'Legendary Mystery Box',
            price: 2999,
            preview: '/assets/mystery-box-legendary.png',
            description: 'Contains 3-5 random cosmetics with legendary chances',
            guaranteedValue: 3000,
            possibleRewards: [
              { type: 'cardBack', rarity: 'epic', chance: 20 },
              { type: 'avatarRing', rarity: 'epic', chance: 20 },
              { type: 'tableSkin', rarity: 'legendary', chance: 15 },
              { type: 'chip-set', rarity: 'epic', chance: 35 },
              { type: 'cardFace', rarity: 'legendary', chance: 10 }
            ]
          }
        ];
      }

      async init() {
        await this.loadUserBalance();
        await this.loadCatalog();
        this.setupEventListeners();
        this.renderStore();
      }

      async loadUserBalance() {
        try {
          const token = localStorage.getItem('user_jwt');
          const response = await fetch('/api/user/balance', {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });
          const data = await response.json();
          this.userBalance = data.balance || 0;
          document.getElementById('user-balance').textContent = `$${this.userBalance.toFixed(2)}`;
        } catch (error) {
          console.error('Failed to load user balance:', error);
          this.userBalance = 1000; // Default balance for demo
          document.getElementById('user-balance').textContent = `$${this.userBalance.toFixed(2)}`;
        }
      }

      async loadCatalog() {
        const statusEl = document.getElementById('catalog-status');
        statusEl.textContent = 'Loading catalog...';
        
        console.log('loadCatalog() called - DEBUG'); // DEBUG
        
        try {
          const response = await fetch('/catalog');
          console.log('Catalog response status:', response.status); // DEBUG
          
          const items = await response.json();
          console.log('Catalog items received:', items.length); // DEBUG
          console.log('Catalog items sample:', items.slice(0, 3)); // DEBUG
          
          this.catalog = items || [];
          this.filteredCatalog = [...this.catalog];
          
          console.log('Catalog set:', this.catalog.length); // DEBUG
          console.log('Filtered catalog set:', this.filteredCatalog.length); // DEBUG
          
          statusEl.textContent = '';
          notifications.show('Catalog loaded successfully', 'success');
        } catch (error) {
          console.error('Failed to load catalog:', error);
          statusEl.textContent = 'Failed to load catalog. Please refresh.';
          notifications.show('Failed to load catalog', 'error');
        }
      }

      setupEventListeners() {
        // Navigation
        document.querySelectorAll('.nav-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            const page = btn.dataset.page;
            if (page === 'editor') {
              window.location.href = 'overlay-editor-enhanced.html';
            } else if (page === 'profile') {
              window.location.href = 'profile.html';
            }
          });
        });

        // Category tabs
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            this.currentCategory = btn.dataset.category;
            this.applyFilters();
          });
        });

        // Filters
        document.getElementById('category-filter').addEventListener('change', (e) => {
          this.currentFilters.category = e.target.value;
          this.applyFilters();
        });

        document.getElementById('rarity-filter').addEventListener('change', (e) => {
          this.currentFilters.rarity = e.target.value;
          this.applyFilters();
        });

        document.getElementById('price-filter').addEventListener('change', (e) => {
          this.currentFilters.price = e.target.value;
          this.applyFilters();
        });

        document.getElementById('search-input').addEventListener('input', (e) => {
          this.currentFilters.search = e.target.value.toLowerCase();
          this.applyFilters();
        });

        // View options
        document.querySelectorAll('.view-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const view = btn.dataset.view;
            document.getElementById('items-grid').className = view === 'list' ? 'items-list' : 'items-grid';
          });
        });

        // Modal
        document.getElementById('modal-close').addEventListener('click', () => {
          this.closeModal();
        });

        document.getElementById('item-modal').addEventListener('click', (e) => {
          if (e.target === e.currentTarget) {
            this.closeModal();
          }
        });

        // Help button
        document.querySelector('.help-btn').addEventListener('click', () => {
          notifications.show('Store guide coming soon!', 'info');
        });
      }

      applyFilters() {
        this.filteredCatalog = this.catalog.filter(item => {
          // Category filter
          if (this.currentCategory !== 'all') {
            if (this.currentCategory === 'featured' && !item.featured) return false;
            if (this.currentCategory === 'new' && !item.new) return false;
            if (this.currentCategory === 'sale' && !item.onSale) return false;
            if (this.currentCategory === 'premium' && item.rarity !== 'legendary') return false;
          }

          // Specific filters
          if (this.currentFilters.category && item.type !== this.currentFilters.category) return false;
          if (this.currentFilters.rarity && item.rarity !== this.currentFilters.rarity) return false;
          if (this.currentFilters.search && !item.name.toLowerCase().includes(this.currentFilters.search)) return false;

          // Price filter
          if (this.currentFilters.price) {
            const price = item.price || 0;
            switch (this.currentFilters.price) {
              case 'free': if (price > 0) return false; break;
              case '0-5': if (price < 0 || price > 5) return false; break;
              case '5-15': if (price < 5 || price > 15) return false; break;
              case '15-30': if (price < 15 || price > 30) return false; break;
              case '30+': if (price < 30) return false; break;
            }
          }

          return true;
        });

        this.currentPage = 1;
        this.renderStore();
      }

      renderStore() {
        this.renderItems();
        this.renderPagination();
        this.renderMysteryBoxes();
        this.renderAICPacks();
      }

      renderItems() {
        console.log('renderItems() called - DEBUG');
        console.log('Catalog length:', this.catalog.length); // DEBUG
        console.log('Filtered catalog length:', this.filteredCatalog.length); // DEBUG
        
        const grid = document.getElementById('items-grid');
        console.log('items-grid element:', grid); // DEBUG
        
        if (!grid) {
          console.error('items-grid element not found!'); // DEBUG
          return;
        }
        
        const start = (this.currentPage - 1) * this.itemsPerPage;
        const end = start + this.itemsPerPage;
        const items = this.filteredCatalog.slice(start, end);

        console.log('Items to render:', items.length); // DEBUG

        grid.innerHTML = '';
        
        if (items.length === 0) {
          grid.innerHTML = '<div class="no-items">No items found matching your criteria.</div>';
          console.log('No items to display'); // DEBUG
          return;
        }

        items.forEach(item => {
          const card = this.createItemCard(item);
          grid.appendChild(card);
        });
        
        console.log('Items rendered successfully'); // DEBUG
      }

      createItemCard(item) {
        const card = document.createElement('div');
        card.className = 'store-item-card';
        
        const isOwned = this.ownedItems.has(item.id);
        const isEquipped = this.equippedItems[item.type] === item.id;
        
        card.innerHTML = `
          <div class="item-visual">
            ${this.buildItemPreview(item)}
            ${item.onSale ? '<div class="sale-badge">SALE</div>' : ''}
            ${item.new ? '<div class="new-badge">NEW</div>' : ''}
            ${isOwned ? '<div class="owned-badge">OWNED</div>' : ''}
            ${isEquipped ? '<div class="equipped-badge">EQUIPPED</div>' : ''}
          </div>
          <div class="item-info">
            <h4 class="item-name">${item.name}</h4>
            <div class="item-meta">
              <span class="rarity-badge ${item.rarity}">${item.rarity || 'common'}</span>
              <span class="item-type">${this.getTypeLabel(item.type)}</span>
            </div>
            <div class="item-price">
              ${item.onSale && item.originalPrice ? 
                `<span class="original-price">$${item.originalPrice}</span>` : ''}
              <span class="current-price">${item.price ? `$${item.price}` : 'FREE'}</span>
            </div>
          </div>
          <div class="item-actions">
            ${!isOwned ? 
              `<button class="btn btn-primary btn-sm" onclick="storeManager.purchaseItem('${item.id}')">Buy</button>` :
              `<button class="btn ${isEquipped ? 'btn-success' : 'btn-secondary'} btn-sm" 
                      onclick="storeManager.equipItem('${item.id}')">${isEquipped ? 'Equipped' : 'Equip'}</button>`}
            <button class="btn btn-outline btn-sm" onclick="storeManager.previewItem('${item.id}')">Preview</button>
          </div>
        `;

        return card;
      }

      buildItemPreview(item) {
        if (item.type.endsWith('Fx')) {
          return `<canvas width="120" height="120" data-item-id="${item.id}" class="fx-preview"></canvas>`;
        }
        
        const imgSrc = item.preview || item.icon || `/assets/cosmetics/${item.type}/${item.id}.png`;
        return `<img src="${imgSrc}" alt="${item.name}" 
                      onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="item-placeholder" style="display:none;">
                  <span class="placeholder-icon">${this.getTypeIcon(item.type)}</span>
                </div>`;
      }

      getTypeLabel(type) {
        const labels = {
          cardBack: 'Card Back',
          cardFace: 'Card Face',
          tableSkin: 'Table Skin',
          avatarRing: 'Avatar Ring',
          chipSkin: 'Chip Skin',
          nameplate: 'Nameplate',
          dealFx: 'Deal Effect',
          winFx: 'Win Effect'
        };
        return labels[type] || 'Cosmetic';
      }

      getTypeIcon(type) {
        const icons = {
          cardBack: 'üé¥',
          cardFace: 'üÉè',
          tableSkin: 'üé∞',
          avatarRing: '‚≠ï',
          chipSkin: 'ü™ô',
          nameplate: 'üè∑Ô∏è',
          dealFx: '‚ú®',
          winFx: 'üéâ'
        };
        return icons[type] || 'üé®';
      }

      renderPagination() {
        const pagination = document.getElementById('pagination');
        const totalPages = Math.ceil(this.filteredCatalog.length / this.itemsPerPage);
        
        if (totalPages <= 1) {
          pagination.innerHTML = '';
          return;
        }

        let html = '<div class="pagination-controls-inner">';
        
        // Previous button
        html += `<button class="pagination-btn" ${this.currentPage === 1 ? 'disabled' : ''} 
                       onclick="storeManager.goToPage(${this.currentPage - 1})">‚Üê</button>`;
        
        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
          if (i === 1 || i === totalPages || (i >= this.currentPage - 1 && i <= this.currentPage + 1)) {
            html += `<button class="pagination-btn ${i === this.currentPage ? 'active' : ''}" 
                           onclick="storeManager.goToPage(${i})">${i}</button>`;
          } else if (i === this.currentPage - 2 || i === this.currentPage + 2) {
            html += '<span class="pagination-ellipsis">...</span>';
          }
        }
        
        // Next button
        html += `<button class="pagination-btn" ${this.currentPage === totalPages ? 'disabled' : ''} 
                       onclick="storeManager.goToPage(${this.currentPage + 1})">‚Üí</button>`;
        
        html += '</div>';
        pagination.innerHTML = html;
      }

      renderMysteryBoxes() {
        const mysteryGrid = document.getElementById('mystery-grid');
        const mysteryBoxes = [
          {
            id: 'box-basic',
            name: 'Basic Mystery Box',
            price: 499,
            preview: '/assets/mystery-box-basic.png',
            description: 'Contains 1-3 random common cosmetics',
            guaranteedValue: 500,
            possibleRewards: [
              { type: 'cardBack', rarity: 'common', chance: 40 },
              { type: 'avatarRing', rarity: 'common', chance: 30 },
              { type: 'tableSkin', rarity: 'common', chance: 30 }
            ]
          },
          {
            id: 'box-premium',
            name: 'Premium Mystery Box',
            price: 1499,
            preview: '/assets/mystery-box-premium.png',
            description: 'Contains 2-4 random cosmetics with rare chances',
            guaranteedValue: 1500,
            possibleRewards: [
              { type: 'cardBack', rarity: 'rare', chance: 25 },
              { type: 'avatarRing', rarity: 'rare', chance: 20 },
              { type: 'tableSkin', rarity: 'epic', chance: 15 },
              { type: 'chip-set', rarity: 'rare', chance: 40 }
            ]
          },
          {
            id: 'box-legendary',
            name: 'Legendary Mystery Box',
            price: 2999,
            preview: '/assets/mystery-box-legendary.png',
            description: 'Contains 3-5 random cosmetics with legendary chances',
            guaranteedValue: 3000,
            possibleRewards: [
              { type: 'cardBack', rarity: 'epic', chance: 20 },
              { type: 'avatarRing', rarity: 'epic', chance: 20 },
              { type: 'tableSkin', rarity: 'legendary', chance: 15 },
              { type: 'chip-set', rarity: 'epic', chance: 35 },
              { type: 'cardFace', rarity: 'legendary', chance: 10 }
            ]
          }
        ];

        mysteryGrid.innerHTML = '';
        mysteryBoxes.forEach(box => {
          const card = document.createElement('div');
          card.className = 'mystery-box-card';
          card.innerHTML = `
            <div class="mystery-preview">
              <div class="box-animation">
                <img src="${box.preview}" alt="${box.name}" class="box-image" width="120" height="120">
                <div class="glow-effect"></div>
              </div>
            </div>
            <div class="mystery-info">
              <h4>${box.name}</h4>
              <p>${box.description}</p>
              <div class="mystery-rewards">
                <div class="reward-chance">
                  <span class="chance-label">Guaranteed Value:</span>
                  <span class="chance-value">$${box.guaranteedValue}</span>
                </div>
                <div class="reward-items">
                  ${box.possibleRewards.map(reward => 
                    `<span class="reward-tag ${reward.rarity}">${this.getTypeLabel(reward.type)} (${reward.chance}%)</span>`
                  ).join('')}
                </div>
              </div>
              <div class="mystery-price">
                <span class="price-current">$${box.price}</span>
                <span class="price-value">Value: $${box.guaranteedValue}</span>
              </div>
              <button class="btn btn-primary btn-glow" onclick="storeManager.openMysteryBox('${box.id}')">
                <span class="btn-icon">üéÅ</span> Open Box
              </button>
            </div>
          `;
          mysteryGrid.appendChild(card);
        });
      }

      async openMysteryBox(boxId) {
        const box = this.mysteryBoxes.find(b => b.id === boxId);
        if (!box) return;

        const price = box.price || 0;
        if (this.userBalance < price) {
          notifications.show('Insufficient balance!', 'error');
          return;
        }

        try {
          // Show opening animation
          this.showBoxOpeningAnimation(box);
          
          // Simulate box opening
          this.userBalance -= price;
          document.getElementById('user-balance').textContent = `$${this.userBalance.toFixed(2)}`;
          
          // Generate random rewards
          const rewards = this.generateBoxRewards(box);
          
          // Show rewards after animation
          setTimeout(() => {
            this.showBoxRewards(box, rewards);
            this.addRewardsToInventory(rewards);
          }, 2000);
          
        } catch (error) {
          console.error('Box opening failed:', error);
          notifications.show('Box opening failed. Please try again.', 'error');
        }
      }

      generateBoxRewards(box) {
        const rewards = [];
        const itemCount = Math.floor(Math.random() * 3) + (box.id === 'box-basic' ? 1 : box.id === 'box-premium' ? 2 : 3);
        
        for (let i = 0; i < itemCount; i++) {
          const roll = Math.random() * 100;
          let cumulative = 0;
          
          for (const reward of box.possibleRewards) {
            cumulative += reward.chance;
            if (roll <= cumulative) {
              rewards.push({
                type: reward.type,
                rarity: reward.rarity,
                name: this.generateRandomItemName(reward.type, reward.rarity)
              });
              break;
            }
          }
        }
        
        return rewards;
      }

      generateRandomItemName(type, rarity) {
        const prefixes = {
          common: ['Basic', 'Simple', 'Standard', 'Classic'],
          rare: ['Elegant', 'Refined', 'Premium', 'Special'],
          epic: ['Mystic', 'Celestial', 'Quantum', 'Aurora'],
          legendary: ['Divine', 'Eternal', 'Mythic', 'Ultimate']
        };
        
        const suffixes = {
          cardBack: ['Card Back', 'Design', 'Pattern'],
          avatarRing: ['Ring', 'Aura', 'Circle'],
          tableSkin: ['Table', 'Surface', 'Felt'],
          chipSet: ['Chip Set', 'Chips', 'Collection'],
          cardFace: ['Card Face', 'Design', 'Style']
        };
        
        const prefix = prefixes[rarity][Math.floor(Math.random() * prefixes[rarity].length)];
        const suffix = suffixes[type][Math.floor(Math.random() * suffixes[type].length)];
        
        return `${prefix} ${suffix}`;
      }

      showBoxOpeningAnimation(box) {
        // Create overlay for animation
        const overlay = document.createElement('div');
        overlay.className = 'box-opening-overlay';
        overlay.innerHTML = `
          <div class="box-opening-container">
            <div class="box-3d">
              <img src="${box.preview}" alt="${box.name}" class="rotating-box">
              <div class="particle-effects"></div>
            </div>
            <div class="opening-text">Opening...</div>
          </div>
        `;
        
        document.body.appendChild(overlay);
        
        // Remove overlay after animation
        setTimeout(() => {
          overlay.remove();
        }, 2000);
      }

      showBoxRewards(box, rewards) {
        const modal = document.getElementById('item-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = modal.querySelector('.modal-body');
        
        modalTitle.textContent = `üéÅ ${box.name} Rewards`;
        
        modalContent.innerHTML = `
          <div class="rewards-display">
            <div class="rewards-grid">
              ${rewards.map((reward, index) => `
                <div class="reward-item ${reward.rarity}" style="animation-delay: ${index * 0.2}s">
                  <div class="reward-icon">${this.getTypeIcon(reward.type)}</div>
                  <div class="reward-info">
                    <div class="reward-name">${reward.name}</div>
                    <div class="reward-meta">
                      <span class="rarity-badge ${reward.rarity}">${reward.rarity}</span>
                      <span class="reward-type">${this.getTypeLabel(reward.type)}</span>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
            <div class="rewards-summary">
              <p>You received ${rewards.length} items!</p>
              <button class="btn btn-primary" onclick="storeManager.closeRewardsModal()">Claim Items</button>
            </div>
          </div>
        `;
        
        modal.style.display = 'flex';
      }

      closeRewardsModal() {
        const modal = document.getElementById('item-modal');
        modal.style.display = 'none';
        notifications.show('Items added to your inventory!', 'success');
        this.renderStore();
      }

      addRewardsToInventory(rewards) {
        rewards.forEach(reward => {
          const itemId = `${reward.type}_${reward.rarity}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
          this.ownedItems.add(itemId);
        });
      }

      renderAICPacks() {
        console.log('renderAICPacks() called - DEBUG');
        const aicGrid = document.getElementById('aic-grid');
        console.log('aic-grid element:', aicGrid); // DEBUG
        
        const aicPacks = [
          { id: 'aic-1', name: 'Neon Dreams Chip Set', price: 1299, preview: '/assets/cosmetics/cards/basic/card-back-purple.svg', type: 'chip-set' },
          { id: 'aic-2', name: 'Cosmic Fire Chip Set', price: 1599, preview: '/assets/cosmetics/avatar/fire_ring.svg', type: 'chip-set' },
          { id: 'aic-3', name: 'Electric Blue Chip Set', price: 999, preview: '/assets/cosmetics/table/neon_green.svg', type: 'chip-set' }
        ];

        if (!aicGrid) {
          console.error('aic-grid element not found!'); // DEBUG
          return;
        }

        aicGrid.innerHTML = '';
        aicPacks.forEach(pack => {
          const card = document.createElement('div');
          card.className = 'aic-pack-card';
          card.innerHTML = `
            <div class="aic-preview">
              <div class="aic-chip-stack-side-view">
                <!-- Main chip stack (side view) -->
                <div class="aic-chip-stack-side">
                  <img src="/assets/cosmetics/effects/chips/chip-500-top.png" alt="500 chip" class="aic-chip-side-item">
                  <img src="/assets/cosmetics/effects/chips/chip-100-top.png" alt="100 chip" class="aic-chip-side-item">
                  <img src="/assets/cosmetics/effects/chips/chip-25-top.png" alt="25 chip" class="aic-chip-side-item">
                  <img src="/assets/cosmetics/effects/chips/chip-5-top.png" alt="5 chip" class="aic-chip-side-item">
                  <img src="/assets/cosmetics/effects/chips/chip-1-top.png" alt="1 chip" class="aic-chip-side-item">
                </div>
                
                <!-- Individual chips leaning against the stack -->
                <div class="aic-chip-leaning-container">
                  <div class="aic-chip-leaning aic-chip-leaning-500">
                    <img src="/assets/cosmetics/effects/chips/chip-500-top.png" alt="500 chip" class="aic-chip-leaning-item">
                  </div>
                  <div class="aic-chip-leaning aic-chip-leaning-100">
                    <img src="/assets/cosmetics/effects/chips/chip-100-top.png" alt="100 chip" class="aic-chip-leaning-item">
                  </div>
                  <div class="aic-chip-leaning aic-chip-leaning-25">
                    <img src="/assets/cosmetics/effects/chips/chip-25-top.png" alt="25 chip" class="aic-chip-leaning-item">
                  </div>
                  <div class="aic-chip-leaning aic-chip-leaning-5">
                    <img src="/assets/cosmetics/effects/chips/chip-5-top.png" alt="5 chip" class="aic-chip-leaning-item">
                  </div>
                  <div class="aic-chip-leaning aic-chip-leaning-1">
                    <img src="/assets/cosmetics/effects/chips/chip-1-top.png" alt="1 chip" class="aic-chip-leaning-item">
                  </div>
                </div>
              </div>
            </div>
            <div class="aic-info">
              <h4>${pack.name}</h4>
              <p>Complete chip set with all denominations</p>
              <div class="aic-price">${pack.price}</div>
              <button class="btn btn-primary btn-sm" onclick="storeManager.purchaseAICPack('${pack.id}')">Generate</button>
            </div>
          `;
          aicGrid.appendChild(card);
        });
        
        console.log('AIC packs rendered:', aicPacks.length); // DEBUG
      }

      goToPage(page) {
        this.currentPage = page;
        this.renderItems();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      async purchaseItem(itemId) {
        const item = this.catalog.find(i => i.id === itemId);
        if (!item) return;

        const price = item.price || 0;
        if (this.userBalance < price) {
          notifications.show('Insufficient balance!', 'error');
          return;
        }

        try {
          // Simulate purchase
          this.userBalance -= price;
          this.ownedItems.add(itemId);
          document.getElementById('user-balance').textContent = `$${this.userBalance.toFixed(2)}`;
          
          notifications.show(`Purchased ${item.name}!`, 'success');
          this.renderStore();
        } catch (error) {
          console.error('Purchase failed:', error);
          notifications.show('Purchase failed. Please try again.', 'error');
        }
      }

      equipItem(itemId) {
        const item = this.catalog.find(i => i.id === itemId);
        if (!item) return;

        this.equippedItems[item.type] = itemId;
        notifications.show(`Equipped ${item.name}!`, 'success');
        this.renderStore();
      }

      previewItem(itemId) {
        const item = this.catalog.find(i => i.id === itemId);
        if (!item) return;

        this.showItemModal(item);
      }

      showItemModal(item) {
        const modal = document.getElementById('item-modal');
        const isOwned = this.ownedItems.has(item.id);
        const isEquipped = this.equippedItems[item.type] === item.id;

        document.getElementById('modal-title').textContent = item.name;
        document.getElementById('modal-item-name').textContent = item.name;
        document.getElementById('modal-rarity').textContent = item.rarity || 'common';
        document.getElementById('modal-rarity').className = `rarity-badge ${item.rarity || 'common'}`;
        document.getElementById('modal-category').textContent = this.getTypeLabel(item.type);
        document.getElementById('modal-description').textContent = item.description || 'No description available.';
        document.getElementById('modal-owned').textContent = isOwned ? 'Yes' : 'No';
        document.getElementById('modal-equipped').textContent = isEquipped ? 'Yes' : 'No';
        document.getElementById('modal-price').textContent = item.price ? `$${item.price}` : 'FREE';

        const modalPreview = document.getElementById('modal-preview');
        modalPreview.innerHTML = this.buildItemPreview(item);

        const buyBtn = document.getElementById('modal-buy-btn');
        const equipBtn = document.getElementById('modal-equip-btn');
        
        buyBtn.style.display = isOwned ? 'none' : 'block';
        equipBtn.disabled = !isOwned;
        equipBtn.textContent = isEquipped ? 'Equipped' : 'Equip';
        equipBtn.className = isEquipped ? 'btn btn-success' : 'btn btn-secondary';

        modal.style.display = 'flex';
      }

      closeModal() {
        document.getElementById('item-modal').style.display = 'none';
      }

      purchaseAICPack(packId) {
        notifications.show('AI pack generation coming soon!', 'info');
      }
    }

    // Initialize store
    const storeManager = new StoreManager();
    storeManager.init(); // This was missing!

    // Enhanced animations
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('animate-in');
        }
      });
    }, { threshold: 0.1 });

    document.querySelectorAll('.glass-panel').forEach(panel => {
      observer.observe(panel);
    });

    // Modal action handlers
    document.getElementById('modal-buy-btn').addEventListener('click', () => {
      const itemName = document.getElementById('modal-item-name').textContent;
      const item = storeManager.catalog.find(i => i.name === itemName);
      if (item) {
        storeManager.purchaseItem(item.id);
        storeManager.closeModal();
      }
    });

    document.getElementById('modal-equip-btn').addEventListener('click', () => {
      const itemName = document.getElementById('modal-item-name').textContent;
      const item = storeManager.catalog.find(i => i.name === itemName);
      if (item) {
        storeManager.equipItem(item.id);
        storeManager.closeModal();
      }
    });

    document.getElementById('modal-preview-btn').addEventListener('click', () => {
      notifications.show('Enhanced preview coming soon!', 'info');
    });
  </script>
</body>
</html>
