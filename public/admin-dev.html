<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dev Admin | All-In Chat Poker</title>
  <link rel="icon" type="image/png" href="logo.png">
  <link rel="stylesheet" href="style-theme.css">
  <link rel="stylesheet" href="style-admin.css">
</head>
<body>
  <div class="container">
    <header class="admin-header">
      <div class="admin-brand">
        <img src="logo.png" alt="All-In Chat Poker logo" class="brand-logo">
        <div>
          <h1>Dev Admin</h1>
          <p class="brand-subtitle">Partner + Earn configuration + debug tools (admin only)</p>
        </div>
      </div>
      <div class="header-actions">
        <span id="session-pill" class="pill muted" style="margin-right:8px;">Session</span>
        <span id="supabase-edge-pill" class="pill muted" style="margin-right:8px;">Supabase: -</span>
        <a class="btn btn-secondary btn-sm" href="/admin2.html">Back to Admin</a>
        <a class="btn btn-secondary btn-sm" href="/admin-chat.html" target="_blank" rel="noopener">AI Bot Chat</a>
        <button id="btn-open-obs-overlay" class="btn btn-secondary btn-sm">OBS Overlay</button>
        <a class="btn btn-secondary btn-sm" href="/admin-code.html" target="_blank" rel="noopener">Code Proposals</a>
      </div>
    </header>

    <main class="admin-main">
      <section class="control-panel compact-card" id="partner-panel-dev">
        <div class="section-header">
          <h2>Partner Program</h2>
          <p class="muted small">Manage partner payouts and view sales/views.</p>
          <p class="muted small">
            Partner docs:
            <a href="/partner-privacy.html" target="_blank" rel="noopener">Partner Privacy</a> Â·
            <a href="/partner-compensation.html" target="_blank" rel="noopener">Comp Addendum</a>
          </p>
        </div>
        <div class="form-grid compact-grid">
          <input id="partner-id" class="form-input" placeholder="partner id (login)">
          <input id="partner-name" class="form-input" placeholder="Display name">
          <input id="partner-pct" class="form-input" type="number" min="0" max="90" step="1" placeholder="Payout % (default 10)">
          <button id="btn-save-partner" class="btn btn-primary btn-sm">Save Partner</button>
          <button id="btn-refresh-partners" class="btn btn-secondary btn-sm">Refresh</button>
        </div>
        <div class="table-responsive">
          <table class="table slim-table" id="partner-table">
            <thead>
              <tr>
                <th>Partner</th>
                <th>Payout %</th>
                <th>Orders</th>
                <th>Coins</th>
                <th>Gross ($)</th>
                <th>Views</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="6" class="muted">No data</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="control-panel compact-card" id="viewer-earn-panel">
        <div class="section-header">
          <h2>Viewer Earn Config</h2>
          <p class="muted small">AIC earn triggers (stored locally; server hooks pending).</p>
        </div>
        <div class="form-grid compact-grid">
          <label>Chat: 1 AIC per N messages</label>
          <input id="earn-chat-rate" class="form-input" type="number" min="1" value="5">
          <label>Chat cap per stream</label>
          <input id="earn-chat-cap" class="form-input" type="number" min="0" value="500">
          <label>New follower reward</label>
          <input id="earn-follower" class="form-input" type="number" min="0" value="25">
          <label>Sub reward</label>
          <input id="earn-sub" class="form-input" type="number" min="0" value="100">
          <label>Raid reward</label>
          <input id="earn-raid" class="form-input" type="number" min="0" value="250">
          <label>Channel point redeem reward</label>
          <input id="earn-redeem" class="form-input" type="number" min="0" value="25">
          <button id="btn-save-earn" class="btn btn-primary btn-sm full-span">Save (local)</button>
        </div>
        <small class="muted">Anti-abuse safeguards (unique chatter cooldown, account age, daily caps) should be enforced server-side.</small>
      </section>

      <section class="control-panel compact-card">
        <div class="section-header">
          <h2>Quick Links</h2>
          <p class="muted small">Open common debug surfaces in new tabs.</p>
        </div>
        <div class="button-row">
          <button id="btn-open-audit" class="btn btn-secondary btn-sm">Audit log JSON</button>
          <button id="btn-open-task-status" class="btn btn-secondary btn-sm">Task queue status</button>
          <button id="btn-open-error-tail" class="btn btn-secondary btn-sm">Error log tail</button>
          <a class="btn btn-secondary btn-sm" href="/partner-dashboard.html" target="_blank" rel="noopener">Partner dashboard</a>
        </div>
      </section>

      <section class="control-panel compact-card" id="premier-review-panel">
        <div class="section-header">
          <h2>Premier Final Review</h2>
          <p class="muted small">Review pending Premier sets, test-apply, and approve/publish.</p>
        </div>
        <div class="button-row">
          <button id="btn-premier-refresh" class="btn btn-secondary btn-sm">Refresh pending</button>
        </div>
        <div class="table-responsive">
          <table class="table slim-table" id="premier-table">
            <thead>
              <tr>
                <th>Login</th>
                <th>Preset</th>
                <th>Submitted</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="4" class="muted">No pending items</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="control-panel compact-card" id="cosmetic-import-panel">
        <div class="section-header">
          <h2>Cosmetic Import (JSON)</h2>
          <p class="muted small">Paste a JSON array of cosmetics and import (admin-only).</p>
        </div>
        <textarea id="cosmetic-import-text" class="form-input" rows="6" placeholder='[{"id":"card-new","type":"cardBack",...}]'></textarea>
        <div class="button-row" style="margin-top:8px;">
          <button id="btn-import-cosmetics" class="btn btn-primary btn-sm">Import</button>
        </div>
        <div id="cosmetic-import-status" class="muted small"></div>
      </section>

      <section class="control-panel compact-card" id="partner-tax-panel">
        <div class="section-header">
          <h2>Partner Tax Forms</h2>
          <p class="muted small">Collect payout details + W-9/W-8 uploads (admin-only; encrypted).</p>
        </div>
        <div class="form-grid compact-grid">
          <input id="tax-partner-id" class="form-input" placeholder="partner id (login)">
          <input id="tax-full-name" class="form-input" placeholder="Legal name">
          <input id="tax-address" class="form-input" placeholder="Address">
          <input id="tax-country" class="form-input" placeholder="Country">
          <input id="tax-email" class="form-input" placeholder="Payout email">
          <select id="tax-form-type" class="form-input">
            <option value="w9">W-9 (US)</option>
            <option value="w8">W-8 (non-US)</option>
          </select>
          <input id="tax-id" class="form-input" placeholder="Tax ID (encrypted)">
          <input id="tax-file" class="form-input" type="file" accept=".pdf" />
          <button id="btn-submit-tax" class="btn btn-primary btn-sm full-span">Upload tax form</button>
        </div>
        <div class="table-responsive">
          <table class="table slim-table" id="tax-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Partner</th>
                <th>Name</th>
                <th>Country</th>
                <th>Form</th>
                <th>Status</th>
                <th>Created</th>
                <th>File</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="8" class="muted">No submissions</td></tr>
            </tbody>
          </table>
        </div>
      </section>


      <section class="control-panel compact-card" id="overlay-health-panel">
        <div class="section-header">
          <h2>Overlay Health</h2>
          <p class="muted small">Live socket stats for the current channel.</p>
        </div>
        <div class="stat-grid">
          <div><strong>Status:</strong> <span id="overlay-status">Not connected</span></div>
          <div><strong>Channel:</strong> <span id="overlay-channel">-</span></div>
          <div><strong>Mode:</strong> <span id="overlay-mode">-</span></div>
          <div><strong>Round:</strong> <span id="overlay-round">-</span></div>
          <div><strong>Betting:</strong> <span id="overlay-betting">-</span></div>
          <div><strong>Last avatar push:</strong> <span id="overlay-avatar-at">-</span></div>
          <div><strong>Last settings push:</strong> <span id="overlay-settings-at">-</span></div>
          <div><strong>Pot / Bet:</strong> <span id="overlay-pot-bet">-</span></div>
          <div><strong>Queue:</strong> <span id="overlay-queue">-</span></div>
        </div>
        <div class="button-row">
          <button id="btn-connect-overlay" class="btn btn-primary btn-sm">Connect socket</button>
          <button id="btn-ping-overlay" class="btn btn-secondary btn-sm">Ping overlays</button>
          <button id="btn-refresh-state" class="btn btn-secondary btn-sm">Refresh state</button>
          <button id="btn-diagnose-ai" class="btn btn-secondary btn-sm">Send to AI</button>
        </div>
        <div id="ai-diagnosis-output" class="muted small"></div>
      </section>

      <section class="control-panel compact-card" id="round-debug-panel">
        <div class="section-header">
          <h2>Round Debugger</h2>
          <p class="muted small">Snapshot of current table state for this channel.</p>
        </div>
        <div id="round-debug-body" class="muted">Waiting for state...</div>
      </section>

      <section class="control-panel compact-card" id="ops-panel">
        <div class="section-header">
          <h2>Ops & Uptime</h2>
          <p class="muted small">Synthetic checks, bot health, errors, and DB safety.</p>
        </div>
        <div class="button-row">
          <button id="btn-ops-refresh" class="btn btn-secondary btn-sm">Refresh ops</button>
          <button id="btn-run-synthetic" class="btn btn-secondary btn-sm">Run synthetic</button>
          <button id="btn-asset-check" class="btn btn-secondary btn-sm">Asset check</button>
          <button id="btn-db-backup" class="btn btn-secondary btn-sm">Backup DB</button>
          <button id="btn-db-vacuum" class="btn btn-secondary btn-sm">VACUUM DB</button>
        </div>
        <div class="muted small" id="ops-summary"></div>
      </section>

      <section class="control-panel compact-card" id="security-panel">
        <div class="section-header">
          <h2>Security Snapshot</h2>
          <p class="muted small">Rate limits, bot health, headers, and file integrity.</p>
        </div>
        <div class="button-row">
          <button id="btn-security-refresh" class="btn btn-secondary btn-sm">Refresh security</button>
          <button id="btn-security-ai" class="btn btn-secondary btn-sm">AI security review</button>
        </div>
        <div class="muted small" id="security-summary"></div>
        <div class="muted small" id="security-diagnosis"></div>
      </section>

      <section class="control-panel compact-card" id="ai-tests-panel">
        <div class="section-header">
          <h2>AI Test Runner</h2>
          <p class="muted small">Generate a quick plan and run available test scripts.</p>
        </div>
        <div class="button-row">
          <button id="btn-run-ai-tests" class="btn btn-primary btn-sm">Run AI Tests</button>
        </div>
        <div class="muted small" id="ai-test-plan"></div>
        <div class="muted small" id="ai-test-results"></div>
        <div class="muted small" id="ai-test-diagnosis"></div>
        <div class="muted small" id="ai-test-last-report"></div>
      </section>

      <section class="control-panel compact-card">
        <div class="section-header">
          <h2>Profile Quick Search</h2>
          <p class="muted small">Jump to any profile; view-only impersonation for cosmetics checks.</p>
        </div>
        <div class="form-grid compact-grid">
          <input id="profile-search-login" class="form-input" placeholder="username/login">
          <button id="btn-open-profile" class="btn btn-primary btn-sm">Open profile</button>
          <button id="btn-open-profile-view" class="btn btn-secondary btn-sm">View as (read-only)</button>
        </div>
      </section>

      <section class="control-panel compact-card" id="partner-snapshot-panel">
        <div class="section-header">
          <h2>Partner Eligibility Snapshot</h2>
          <p class="muted small">30d window; refresh/recompute from backend.</p>
        </div>
        <div class="button-row">
          <button id="btn-refresh-snapshot" class="btn btn-primary btn-sm">Refresh</button>
          <button id="btn-recompute-snapshot" class="btn btn-secondary btn-sm">Recompute</button>
        </div>
        <div class="table-responsive">
          <table class="table slim-table" id="partner-snapshot-table">
            <thead>
              <tr>
                <th>Channel</th>
                <th>Streams (30d)</th>
                <th>Avg Players</th>
                <th>Unique Players</th>
                <th>Rounds</th>
                <th>Goals Met</th>
                <th>Profile</th>
              </tr>
            </thead>
            <tbody id="partner-snapshot-body">
              <tr><td colspan="7" class="muted">No data yet</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="control-panel compact-card" id="import-export-panel">
        <div class="section-header">
          <h2>Import / Export</h2>
          <p class="muted small">Cosmetic import (JSON/CSV) + partner export.</p>
        </div>
        <div class="form-grid compact-grid">
          <textarea id="dev-import-input" class="form-input" rows="5" placeholder='[{"id":"card-back-new","type":"cardBack","name":"New Back","price_cents":500}] or CSV with headers'></textarea>
          <button id="btn-import-cosmetics-dev" class="btn btn-primary btn-sm">Import cosmetics</button>
          <button id="btn-export-partners" class="btn btn-secondary btn-sm">Export partners (CSV)</button>
          <button id="btn-seed-cosmetics" class="btn btn-secondary btn-sm">Seed sample cosmetics</button>
          <div id="dev-import-status" class="muted small"></div>
        </div>
      </section>

      <section class="control-panel compact-card" id="game-tools-panel">
        <div class="section-header">
          <h2>Game State Controls</h2>
          <p class="muted small">Admin-only socket commands for fast testing.</p>
        </div>
        <div class="button-row">
          <button id="btn-open-betting-dev" class="btn btn-primary btn-sm">Open betting</button>
          <button id="btn-start-now-dev" class="btn btn-secondary btn-sm">Start round now</button>
          <button id="btn-add-bots-dev" class="btn btn-secondary btn-sm">Add 3 test bots</button>
          <label class="inline-toggle">
            <input type="checkbox" id="auto-bet-bots" checked> auto-bet/start
          </label>
        </div>
      </section>

      <section class="control-panel compact-card" id="feature-flags-panel">
        <div class="section-header">
          <h2>Feature Toggles</h2>
          <p class="muted small">Stored locally; wire to backend flags as needed.</p>
        </div>
        <div class="form-grid compact-grid">
          <label class="inline-toggle"><input type="checkbox" id="flag-drops"> Enable drops</label>
          <label class="inline-toggle"><input type="checkbox" id="flag-avatar-refresh" checked> Avatar auto-refresh</label>
          <label>Dealer animation speed
            <select id="flag-deal-speed" class="form-input">
              <option value="normal">Normal</option>
              <option value="fast">Fast</option>
              <option value="slow">Slow</option>
            </select>
          </label>
        </div>
      </section>

      <section class="control-panel compact-card" id="safety-panel">
        <div class="section-header">
          <h2>Safety / Recovery</h2>
          <p class="muted small">Quick fixes for overlays and local caches.</p>
        </div>
        <div class="button-row">
          <button id="btn-reset-overlay" class="btn btn-secondary btn-sm">Reset overlay settings</button>
          <button id="btn-clear-cache" class="btn btn-secondary btn-sm">Clear local caches</button>
          <button id="btn-clear-health" class="btn btn-secondary btn-sm">Clear health counters</button>
        </div>
      </section>

      <section class="control-panel compact-card" id="user-role-panel">
        <div class="section-header">
          <h2>User Role Management</h2>
          <p class="muted small">Grant dev/owner roles to users for collaboration.</p>
        </div>
        <div class="form-grid compact-grid">
          <input id="role-user-login" class="form-input" placeholder="User login (lowercase)">
          <select id="role-user-role" class="form-input">
            <option value="">Select role...</option>
            <option value="player">Player</option>
            <option value="streamer">Streamer</option>
            <option value="admin">Admin</option>
            <option value="dev">Dev</option>
            <option value="owner">Owner</option>
            <option value="premier">Premier</option>
            <option value="ai">AI</option>
          </select>
          <button id="btn-update-user-role" class="btn btn-primary btn-sm">Update Role</button>
          <button id="btn-refresh-user-roles" class="btn btn-secondary btn-sm">Refresh Users</button>
        </div>
        <div id="role-update-status" class="muted small" style="margin-top: 8px;"></div>
        <div class="table-responsive" style="margin-top: 16px;">
          <table class="table slim-table" id="user-roles-table">
            <thead>
              <tr>
                <th>Login</th>
                <th>Display Name</th>
                <th>Current Role</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="4" class="muted">Loading users...</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <section class="control-panel compact-card" id="user-password-panel">
        <div class="section-header">
          <h2>User Password Management</h2>
          <p class="muted small">Set passwords for username/password login access.</p>
        </div>
        <div class="form-grid compact-grid">
          <input id="password-user-login" class="form-input" placeholder="User login (lowercase)">
          <input id="password-user-password" class="form-input" type="password" placeholder="New password (min 8 chars)">
          <button id="btn-set-user-password" class="btn btn-primary btn-sm">Set Password</button>
          <div></div>
        </div>
        <div id="password-update-status" class="muted small" style="margin-top: 8px;"></div>
      </section>
    </main>
  </div>

  <div id="toast-container" class="toast-container"></div>

  <script src="client.js"></script>
  <script>
    (function () {
      const btn = document.getElementById('btn-open-obs-overlay');
      if (!btn) return;
      const decodeLogin = (tok) => {
        if (!tok || typeof tok !== 'string') return '';
        try {
          const payload = tok.split('.')[1];
          const pad = payload.length % 4 === 2 ? '==' : payload.length % 4 === 3 ? '=' : '';
          const data = JSON.parse(atob(payload.replace(/-/g, '+').replace(/_/g, '/') + pad));
          return (data.user || data.login || '').toLowerCase();
        } catch {
          return '';
        }
      };
      const tok = (localStorage.getItem && localStorage.getItem('user_jwt')) || '';
      const login = decodeLogin(tok);
      const href = login ? `/obs-overlay.html?channel=${encodeURIComponent(login)}` : '/obs-overlay.html';
      btn.addEventListener('click', () => window.open(href, '_blank', 'noopener'));
    })();
  </script>
  <script>
    enforceAuthenticatedPage({ page: 'admin' });
  </script>
  <script src="/socket.io/socket.io.js"></script>
  <script src="admin-dev.js"></script>
</body>
</html>
